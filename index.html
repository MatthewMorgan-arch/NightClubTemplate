<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lost Property — Quick Upload (Improved OCR)</title>
  <style>
    body {
      font-family: system-ui, Segoe UI, Helvetica, Arial;
      max-width: 720px;
      margin: 2rem auto;
      padding: 1rem;
    }
    label { display: block; margin: 0.6rem 0; }
    .btn { padding: 0.6rem 0.9rem; border-radius: 6px; border: 0; background: #111; color: #fff; cursor: pointer; }
    .small { font-size: 0.9rem; color: #555; }
    #overlay {
      display: none;
      position: fixed;
      inset: 0;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.6);
      color: #fff;
      font-size: 1.1rem;
      z-index: 999;
    }
    input, select, textarea {
      font-size: 1rem;
      padding: 0.4rem;
      margin-top: 0.2rem;
      width: 100%;
      box-sizing: border-box;
    }
    .hidden { display: none; }
    fieldset {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 0.8rem;
      margin-top: 1rem;
      background: #fbfbfb;
    }
    .ocr-status {
      font-size: 0.9rem;
      color: #444;
      margin-top: 0.3rem;
    }
    details { margin-top: 0.6rem; }
    pre { white-space: pre-wrap; font-size: 0.9rem; background:#fff; padding:0.6rem; border-radius:6px; border:1px solid #eee; }
  </style>
</head>
<body>
  <h1>Quick Lost Item Upload</h1>
  <p class="small">Scan QR → snap photo → choose category → submit. Takes ~10s. Photos retained 30 days.</p>

  <form id="uploadForm" action="https://hook.eu2.make.com/gkebdrmtjlkwd6wikd1wsmoht4x41p9v" method="post" enctype="multipart/form-data" target="hidden_iframe" autocomplete="off">
    <input type="hidden" name="venue" id="venueInput" value="Club X">

    <label>Photo (required)
      <input type="file" id="photoInput" name="photo" accept="image/*;capture=camera" required>
      <div id="ocrStatus" class="ocr-status"></div>
    </label>

    <label>Category
      <select name="category" id="categorySelect" required>
        <option value="">Select...</option>
        <option>ID</option>
        <option>Wallet</option>
        <option>Phone</option>
        <option>Keys</option>
        <option>Card</option>
        <option>Bag</option>
        <option>Clothing</option>
        <option>Other</option>
      </select>
    </label>

    <label>Short description (required)
      <input name="desc" id="descInput" maxlength="120" placeholder="e.g. black leather wallet" required>
    </label>

    <fieldset id="idFields" class="hidden">
      <legend>ID Details</legend>
      <label>First Name <input name="id_firstName" id="id_firstName"></label>
      <label>Last Name <input name="id_lastName" id="id_lastName"></label>
      <label>ID Number (last 4 digits only) <input name="id_number" id="id_number" placeholder="e.g. 1234"></label>

      <details id="ocrDetails">
        <summary>OCR raw text & suggestions (click to expand)</summary>
        <div style="margin-top:0.5rem">
          <strong>Raw OCR text</strong>
          <pre id="ocrRaw">—</pre>

          <strong>Detected suggestion</strong>
          <pre id="ocrSuggestion">—</pre>

          <div style="margin-top:0.5rem" class="small">If suggestion is wrong, edit the name/ID fields before submitting.</div>
        </div>
      </details>
    </fieldset>

    <fieldset id="walletFields" class="hidden">
      <legend>Wallet — Card Name</legend>
      <label>First Name <input name="wallet_firstName"></label>
      <label>Last Name <input name="wallet_lastName"></label>
    </fieldset>

    <fieldset id="cardFields" class="hidden">
      <legend>Card Details</legend>
      <label>First Name <input name="card_firstName"></label>
      <label>Last Name <input name="card_lastName"></label>
    </fieldset>

    <label>Found by (optional)
      <input name="foundBy" maxlength="50" placeholder="e.g. Joe - bar">
    </label>

    <button class="btn" type="submit">Upload</button>
  </form>

  <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>
  <div id="overlay">Uploading… please wait</div>
  <div id="result" style="display:none;margin-top:1rem;padding:0.8rem;border:1px solid #ddd;border-radius:6px;background:#fbfbfb"></div>

  <!-- OCR Library -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

  <script>
  (function(){
    const params = new URLSearchParams(location.search);
    const venue = params.get('venue') || 'Club X';
    document.getElementById('venueInput').value = venue;

    const form = document.getElementById('uploadForm');
    const overlay = document.getElementById('overlay');
    const result = document.getElementById('result');
    const iframe = document.getElementById('hidden_iframe');
    const categorySelect = document.getElementById('categorySelect');
    const idFields = document.getElementById('idFields');
    const walletFields = document.getElementById('walletFields');
    const cardFields = document.getElementById('cardFields');
    const photoInput = document.getElementById('photoInput');
    const ocrStatus = document.getElementById('ocrStatus');
    const ocrRaw = document.getElementById('ocrRaw');
    const ocrSuggestion = document.getElementById('ocrSuggestion');

    // show/hide relevant sections and toggle required
    categorySelect.addEventListener('change', () => {
      const val = categorySelect.value;
      [idFields, walletFields, cardFields].forEach(f => {
        f.classList.add('hidden');
        Array.from(f.querySelectorAll('input')).forEach(i => i.required = false);
      });

      if (val === 'ID') {
        idFields.classList.remove('hidden');
        idFields.querySelectorAll('input').forEach(i => i.required = true);
      } else if (val === 'Wallet') {
        walletFields.classList.remove('hidden');
        walletFields.querySelectorAll('input').forEach(i => i.required = true);
      } else if (val === 'Card') {
        cardFields.classList.remove('hidden');
        cardFields.querySelectorAll('input').forEach(i => i.required = true);
      }
    });

    // small helpers
    function onlyDigits(s){ return (s||'').replace(/\D/g,''); }
    function normalizeForNumbers(s){
      // replace common OCR confusions *for strings that should be numeric*
      if(!s) return s;
      return s.replace(/[Oo]/g,'0').replace(/[Il\|]/g,'1').replace(/S/g,'5').replace(/B/g,'8');
    }
    function compact(s){ return (s||'').replace(/\s+/g,'').replace(/[^A-Za-z0-9]/g,''); }
    function titleCase(s){ if(!s) return ''; return s.split(/\s+/).map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' '); }

    // parse OCR output with heuristics
    function parseOCR(text){
      const raw = (text||'').replace(/\r/g,'\n');
      const lines = raw.split('\n').map(l => l.trim()).filter(Boolean);

      // find MRZ-like lines (look for '<' char often present on passports)
      const mrzLines = lines.filter(l => l.includes('<') && l.replace(/\s/g,'').length >= 30);
      let suggestion = { id: null, first: '', last: '', source: 'none' };

      // 1) If MRZ present, try crude MRZ name parse
      if(mrzLines.length){
        const joined = mrzLines.join(' ').replace(/\s+/g,' ');
        // MRZ often includes '<<' between surname/given names
        const m = joined.match(/([A-Z<]{3,}<<[A-Z<]{2,})/i);
        const trimmed = m ? m[0] : joined;
        const parts = trimmed.split('<<');
        if(parts.length >= 2){
          const surname = parts[0].replace(/</g,' ').trim();
          const given = parts[1].replace(/</g,' ').trim().split(' ')[0] || '';
          suggestion.first = titleCase(given.split(' ').slice(0,2).join(' '));
          suggestion.last = titleCase(surname.split(' ').slice(0,2).join(' '));
          suggestion.source = 'mrz';
        }
      }

      // 2) Look for explicit labelled fields like "Surname", "Name", "Driver no", "Licence no"
      const lower = raw.toLowerCase();
      // ID number candidate detection: sequences of digits/alphanum
      const digitSeq = (raw.match(/\d{6,}/g) || []).map(s => s.trim());
      const alphaNumSeq = (raw.match(/[A-Z0-9][A-Z0-9\-\s]{5,20}/gi) || []).map(s => s.trim());
      const allCandidates = Array.from(new Set([...digitSeq, ...alphaNumSeq]));

      // scoring function: prefer candidates near label words
      const labelKeywords = ['licence','license','licence no','licence number','driving licence','driving license','driving no','driver number','driver no','lic no','id no','id number','id:','dl:','lic:','licn:','lic no.','licence no.'];
      const lowerFull = raw.toLowerCase();

      let scored = allCandidates.map(c => {
        const norm = compact(c);
        let score = 0;
        const ci = lowerFull.indexOf(c.toLowerCase());
        if(ci >= 0){
          for(const kw of labelKeywords){
            const kidx = lowerFull.indexOf(kw);
            if(kidx >= 0 && Math.abs(kidx - ci) < 75) score += 4;
          }
        }
        if(/[A-Za-z]/.test(norm) && /\d/.test(norm)) score += 2; // alnum
        score += Math.min(6, norm.length / 4);
        return { raw: c, norm, score };
      });
      scored = scored.sort((a,b) => b.score - a.score);

      let bestId = scored.length ? scored[0].raw : null;

      // If MRZ didn't give name, try to find name labels
      if(!suggestion.first && !suggestion.last){
        const nameLabelPatterns = [
          /surname[:\s]*([A-Z ,.'-]+)/i,
          /last name[:\s]*([A-Z ,.'-]+)/i,
          /family name[:\s]*([A-Z ,.'-]+)/i,
          /name[:\s]*([A-Z ,.'-]+)/i,
          /holder[:\s]*([A-Z ,.'-]+)/i
        ];
        for(const pat of nameLabelPatterns){
          const m = raw.match(pat);
          if(m && m[1]){
            const candidate = m[1].replace(/[^A-Za-z\s\-,']/g,' ').trim();
            if(candidate){
              // if comma present: "SURNAME, FORNAME"
              if(candidate.includes(',')){
                const [s,f] = candidate.split(',',2);
                suggestion.last = titleCase(s.trim());
                suggestion.first = titleCase(f.trim().split(' ')[0] || '');
              } else {
                const words = candidate.split(/\s+/).filter(Boolean);
                suggestion.first = titleCase(words[0] || '');
                suggestion.last = titleCase(words.slice(-1)[0] || '');
              }
              suggestion.source = 'label';
              break;
            }
          }
        }
      }

      // Fallback name heuristic: choose a line with mostly letters and 2-3 words and few digits
      if(!suggestion.first && !suggestion.last){
        let candidateLine = '';
        let bestScore = 0;
        lines.forEach(line => {
          const letters = (line.match(/[A-Za-z]/g) || []).length;
          const digits = (line.match(/\d/g) || []).length;
          const words = line.split(/\s+/).filter(Boolean).length;
          const score = letters - digits + (words>=2 ? 2 : 0);
          if(score > bestScore && letters > 3 && digits < 3 && words >= 2){
            bestScore = score;
            candidateLine = line;
          }
        });
        if(candidateLine){
          // prefer "SURNAME, FORENAMES" form
          if(candidateLine.includes(',')){
            const [s,f] = candidateLine.split(',',2);
            suggestion.last = titleCase(s.replace(/[^A-Za-z\s'-]/g,' ').trim());
            suggestion.first = titleCase((f||'').replace(/[^A-Za-z\s'-]/g,' ').trim().split(' ')[0] || '');
          } else {
            const w = candidateLine.replace(/[^A-Za-z\s'-]/g,' ').trim().split(/\s+/);
            suggestion.first = titleCase(w[0]||'');
            suggestion.last = titleCase(w[w.length-1]||'');
          }
          suggestion.source = 'heuristic';
        }
      }

      // Prepare suggestion text
      const suggestionText = {
        idCandidates: scored.map(s => s.raw).slice(0,6),
        selectedId: bestId || null,
        parsedNameFirst: suggestion.first || null,
        parsedNameLast: suggestion.last || null,
        source: suggestion.source || null,
        rawTextPreview: lines.slice(0,25).join('\n')
      };

      return { suggestion, suggestionText, raw };
    }

    // OCR scanning
    photoInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      ocrStatus.textContent = 'Scanning image (OCR) — please hold on…';
      ocrRaw.textContent = '—';
      ocrSuggestion.textContent = '—';
      try {
        // run tesseract
        const { data: { text } } = await Tesseract.recognize(file, 'eng', {
          logger: m => {
            // optionally show progress
            if(m && m.status && m.progress){
              const p = Math.round(m.progress*100);
              ocrStatus.textContent = `Scanning image (OCR) — ${m.status} ${p}%`;
            }
          }
        });

        ocrStatus.textContent = 'Processing OCR results…';
        const parsed = parseOCR(text);

        // fill raw text & suggestions
        ocrRaw.textContent = parsed.raw;
        ocrSuggestion.textContent = JSON.stringify(parsed.suggestionText, null, 2);

        // Use best ID candidate: normalize numeric confusion for numeric strings
        let best = parsed.suggestionText.selectedId;
        if(best){
          // if candidate contains digits, try to produce numeric-only and fix common OCR confusions
          let candidate = best;
          // If candidate is mixed, attempt to extract most digit-rich substring
          const digitGroups = candidate.match(/\d{4,}/g);
          if(digitGroups && digitGroups.length) {
            candidate = digitGroups[0];
          }
          // normalize typical OCR letter/digit confusions for numeric parts
          const normalized = normalizeForNumbers(candidate);
          const digits = onlyDigits(normalized);
          if(digits.length >= 4){
            document.getElementById('id_number').value = digits.slice(-4);
          } else {
            // fallback: last 4 chars from compact form
            const comp = compact(candidate);
            document.getElementById('id_number').value = comp.slice(-4);
          }
        }

        // Fill name fields if found (staff should verify)
        const pf = parsed.suggestionText.parsedNameFirst;
        const pl = parsed.suggestionText.parsedNameLast;
        if(pf) document.getElementById('id_firstName').value = pf;
        if(pl) document.getElementById('id_lastName').value = pl;

        ocrStatus.textContent = '✅ OCR suggestion filled (please verify fields).';

      } catch (err) {
        console.error('OCR error', err);
        ocrStatus.textContent = '❌ OCR failed — please enter details manually.';
      }
    });

    // Submission overlay
    form.addEventListener('submit', function(){
      overlay.style.display = 'flex';
    });

    iframe.addEventListener('load', function(){
      overlay.style.display = 'none';
      result.style.display = 'block';
      result.innerText = 'Upload received. Keep item secure. Add claim code to manager noticeboard.';
      form.reset();
      [idFields, walletFields, cardFields].forEach(f => f.classList.add('hidden'));
      ocrStatus.textContent = '';
      ocrRaw.textContent = '—';
      ocrSuggestion.textContent = '—';
    });
  })();
  </script>
</body>
</html>
